# Stranzit Audio Downloader

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python 3.12](https://img.shields.io/badge/python-3.12-blue.svg)](https://www.python.org/downloads/)
[![Platform: Linux](https://img.shields.io/badge/platform-Linux%20%7C%20macOS-lightgrey.svg)](https://github.com/FUYOH666/voip-calls-downloader)

**Автоматизированная система для мониторинга и загрузки новых аудио-звонков из личного кабинета [lk.stranzit.ru](https://lk.stranzit.ru/Account).**

---

## Краткое описание

Stranzit Audio Downloader — это инструмент для автоматической загрузки записей телефонных звонков из личного кабинета Связьтранзит. Проект помогает избавиться от ручной рутины, экономя время и энергию.

---

## Проблемы, которые решает

- **Ручная загрузка записей** — больше не нужно вручную заходить в личный кабинет и скачивать файлы
- **Отслеживание новых звонков** — автоматический мониторинг и загрузка новых записей
- **Дублирование файлов** — автоматическое отслеживание уже загруженных записей
- **Фильтрация** — настройка фильтров по направлению, длительности и другим параметрам

---

## Возможности

- ✅ Мониторинг входящих звонков в реальном времени
- ✅ Автоматическая загрузка новых записей
- ✅ Читаемые имена файлов в формате: `ДД.ММ.ГГГГ_ЧЧ-ММ-СС_НОМЕР_НАПРАВЛЕНИЕ.mp3`
- ✅ Отслеживание загруженных файлов (без дублирования)
- ✅ Безопасная обработка credentials через переменные окружения
- ✅ Health check и мониторинг состояния системы
- ✅ Автоматический перезапуск при сбоях
- ✅ Поддержка cron для автоматического запуска
- ✅ Настраиваемые фильтры по направлению и длительности

---

## Требования

- **Python 3.12** или выше
- **Linux** или **macOS** (Windows не поддерживается)
- Доступ к интернету
- Учетные данные для входа в личный кабинет lk.stranzit.ru

---

## Установка

### Шаг 1: Подготовка проекта

```bash
cd svyaztransit
```

### Шаг 2: Создание виртуального окружения

```bash
python3.12 -m venv venv
source venv/bin/activate  # или: . venv/bin/activate
```

### Шаг 3: Установка зависимостей

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

---

## Конфигурация

### Шаг 1: Создание файла конфигурации

Скопируйте файл примера настроек:

```bash
cp env_example.txt .env
```

### Шаг 2: Редактирование .env файла

Откройте файл `.env` в любом текстовом редакторе и заполните:

- `STRANZIT_USERNAME` - ваш логин для входа в личный кабинет
- `STRANZIT_PASSWORD` - ваш пароль

### Шаг 3: Дополнительные настройки

При необходимости настройте другие параметры:
- Интервал проверки (`CHECK_INTERVAL`)
- Фильтры записей (`CALL_FILTER_*`)
- Папка для загрузок (`DOWNLOAD_DIR`)

Подробные описания всех параметров смотрите в файле `env_example.txt`.

---

## Использование

### Однократный запуск

Выполнить одну проверку новых звонков и завершить работу:

```bash
./venv/bin/python call_records_watcher.py --once
```

### Непрерывный режим работы

Запустить программу в режиме постоянного мониторинга:

```bash
./venv/bin/python call_records_watcher.py
```

Программа будет проверять новые звонки каждые 5 минут (или другой интервал, указанный в `.env`). Для остановки нажмите `Ctrl+C`.

### Автоматический запуск через cron

Для автоматической работы программы в фоне настройте cron:

```bash
./setup_cron.sh
```

Скрипт предложит выбрать интервал проверки (каждую минуту, каждые 5 минут или каждые 10 минут).

---

## Мониторинг работы

### Проверка состояния системы

```bash
./venv/bin/python health_check.py
```

Скрипт покажет:
- Свободное место на диске
- Статус работающих процессов
- Статистику базы данных
- Количество загруженных файлов
- Размер логов

### Просмотр логов

```bash
tail -f watcher.log
```

### Автоматический перезапуск при сбоях

Для автоматического перезапуска программы при сбоях запустите:

```bash
./venv/bin/python auto_restart.py
```

---

## Примеры использования

### Пример 1: Однократная загрузка звонков за сегодня

1. Настройте `.env`:
   ```bash
   CALL_FILTER_START=today_start
   CALL_FILTER_END=now
   CALL_FILTER_DIRECTION=incoming
   ```

2. Запустите:
   ```bash
   ./venv/bin/python call_records_watcher.py --once
   ```

### Пример 2: Загрузка всех входящих звонков длительностью более 3 минут

1. Настройте `.env`:
   ```bash
   CALL_FILTER_DIRECTION=incoming
   CALL_FILTER_DURATION_OP=>=
   CALL_FILTER_DURATION=00:03:00
   ```

2. Запустите в непрерывном режиме:
   ```bash
   ./venv/bin/python call_records_watcher.py
   ```

---

## Настройка параметров

Все настройки находятся в файле `.env`. Основные параметры:

| Параметр | Значение по умолчанию | Описание |
|----------|----------------------|----------|
| `DOWNLOAD_DIR` | `./downloads` | Папка для сохранения файлов |
| `CHECK_INTERVAL` | `300` | Интервал проверки в секундах (5 минут) |
| `CALL_FILTER_START` | `today_start` | Начало периода для поиска звонков |
| `CALL_FILTER_END` | `now` | Конец периода для поиска звонков |
| `CALL_FILTER_DIRECTION` | `incoming` | Направление звонков (`incoming`, `outgoing`, `any`) |
| `CALL_FILTER_DURATION_OP` | `>=` | Оператор фильтра по длительности |
| `CALL_FILTER_DURATION` | `00:03:00` | Значение длительности в формате ЧЧ:ММ:СС |

Подробные описания всех параметров смотрите в файле `env_example.txt`.

---

## Структура проекта

```
svyaztransit/
├── call_records_watcher.py   # Основной скрипт загрузчика
├── stranzit_auth.py          # Модуль аутентификации
├── health_check.py           # Скрипт проверки состояния системы
├── auto_restart.py           # Скрипт автоматического перезапуска
├── run_watcher.sh            # Скрипт для запуска через cron
├── setup_cron.sh            # Скрипт настройки автоматического запуска
├── requirements.txt          # Список зависимостей Python
├── env_example.txt           # Пример файла настроек
└── README.md                 # Эта инструкция
```

---

## Безопасность

- Логин и пароль хранятся только в файле `.env`, который не должен попадать в git
- Пароли никогда не логируются и не передаются третьим лицам
- Файл `.env` добавлен в `.gitignore` для безопасности
- Никогда не коммитьте `.env` файлы в репозиторий

---

## Частые проблемы

### Ошибка "Не установлены credentials"

**Решение:** Проверьте, что файл `.env` существует и содержит `STRANZIT_USERNAME` и `STRANZIT_PASSWORD`.

### Ошибка "Ошибка входа"

**Решение:** Проверьте правильность логина и пароля в файле `.env`. Убедитесь, что у вас есть доступ к интернету и сайт lk.stranzit.ru доступен.

### Файлы не загружаются

**Возможные причины:**
- Нет свободного места на диске
- Папка `downloads/` не существует или недоступна для записи
- Нет новых звонков за указанный период

**Решение:**
- Проверьте наличие свободного места на диске
- Убедитесь, что папка `downloads/` существует и доступна для записи
- Проверьте логи: `tail -f watcher.log`

### Программа не запускается

**Решение:**
- Убедитесь, что виртуальное окружение активировано: `source venv/bin/activate`
- Проверьте установку зависимостей: `pip install -r requirements.txt`
- Проверьте версию Python: `python3 --version` (должна быть 3.12 или выше)

---

## Важные замечания

1. Убедитесь, что использование соответствует правилам сервиса lk.stranzit.ru
2. Используйте разумные интервалы между запросами (минимум 5 минут)
3. Регулярно проверяйте наличие свободного места на диске
4. Делайте резервные копии папки `downloads/` и базы данных

---

## Поддержка

При возникновении проблем проверьте:
1. Логи в файле `watcher.log`
2. Настройки в файле `.env`
3. Состояние системы через `health_check.py`

---

## Contributing

Мы рады любому вкладу! Пожалуйста, прочитайте [CONTRIBUTING.md](../CONTRIBUTING.md) в корне репозитория.

---

## Лицензия

Этот проект распространяется под лицензией MIT. См. [LICENSE](../LICENSE) для получения подробной информации.

---

*Автоматизированная система для загрузки аудио-звонков из личного кабинета Stranzit*
