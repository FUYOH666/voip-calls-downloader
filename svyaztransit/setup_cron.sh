#!/bin/bash
# ะะฐัััะพะนะบะฐ Cron ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะทะฐะฟััะบะฐ Stranzit Watcher

echo "๐ต ะะฐัััะพะนะบะฐ ะฐะฒัะพะผะฐัะธัะตัะบะพะน ะทะฐะณััะทะบะธ ะทะฒะพะฝะบะพะฒ"
echo "============================================"

# ะะพะปััะฐะตะผ ะฟััั ะบ ะฟัะพะตะบัั
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPT_PATH="$PROJECT_DIR/run_watcher.sh"

echo "๐ ะััั ะบ ะฟัะพะตะบัั: $PROJECT_DIR"
echo "๐ ะกะบัะธะฟั ะดะปั cron: $SCRIPT_PATH"

# ะัะพะฒะตััะตะผ, ัััะตััะฒัะตั ะปะธ ัะบัะธะฟั
if [ ! -f "$SCRIPT_PATH" ]; then
    echo "โ ะัะธะฑะบะฐ: ัะบัะธะฟั $SCRIPT_PATH ะฝะต ะฝะฐะนะดะตะฝ!"
    exit 1
fi

# ะัะพะฒะตััะตะผ, ะธัะฟะพะปะฝัะตะผัะน ะปะธ ัะบัะธะฟั
if [ ! -x "$SCRIPT_PATH" ]; then
    echo "๐ง ะะตะปะฐะตะผ ัะบัะธะฟั ะธัะฟะพะปะฝัะตะผัะผ..."
    chmod +x "$SCRIPT_PATH"
fi

echo ""
echo "๐ ะะฐัะธะฐะฝัั ะฝะฐัััะพะนะบะธ:"
echo "1. ะะฐะถะดัั ะผะธะฝััั (ัะตะบะพะผะตะฝะดัะตััั)"
echo "2. ะะฐะถะดัะต 5 ะผะธะฝัั"
echo "3. ะะฐะถะดัะต 10 ะผะธะฝัั"
echo "4. ะัะผะตะฝะฐ"

read -p "ะัะฑะตัะธัะต ะฒะฐัะธะฐะฝั (1-4): " choice

case $choice in
    1)
        cron_line="* * * * * $SCRIPT_PATH"
        echo "โ ะัะฑัะฐะฝะพ: ะบะฐะถะดัั ะผะธะฝััั"
        ;;
    2)
        cron_line="*/5 * * * * $SCRIPT_PATH"
        echo "โ ะัะฑัะฐะฝะพ: ะบะฐะถะดัะต 5 ะผะธะฝัั"
        ;;
    3)
        cron_line="*/10 * * * * $SCRIPT_PATH"
        echo "โ ะัะฑัะฐะฝะพ: ะบะฐะถะดัะต 10 ะผะธะฝัั"
        ;;
    4)
        echo "โ ะะฐัััะพะนะบะฐ ะพัะผะตะฝะตะฝะฐ"
        exit 0
        ;;
    *)
        echo "โ ะะตะฒะตัะฝัะน ะฒัะฑะพั. ะัะฟะพะปัะทัั ะทะฝะฐัะตะฝะธะต ะฟะพ ัะผะพะปัะฐะฝะธั (ะบะฐะถะดัั ะผะธะฝััั)"
        cron_line="* * * * * $SCRIPT_PATH"
        ;;
esac

echo ""
echo "๐ ะะพะฑะฐะฒะปัะตะผ ะฒ crontab:"
echo "$cron_line"
echo ""

# ะัะพะฒะตััะตะผ, ะตััั ะปะธ ัะถะต ัะฐะบะฐั ัััะพะบะฐ ะฒ crontab
if crontab -l 2>/dev/null | grep -q "$SCRIPT_PATH"; then
    echo "โ๏ธ  ะ crontab ัะถะต ะตััั ะทะฐะฟะธัั ะดะปั ััะพะณะพ ัะบัะธะฟัะฐ"
    read -p "ะะฑะฝะพะฒะธัั? (y/n): " update
    if [[ $update =~ ^[Yy]$ ]]; then
        # ะฃะดะฐะปัะตะผ ััะฐััั ัััะพะบั ะธ ะดะพะฑะฐะฒะปัะตะผ ะฝะพะฒัั
        crontab -l 2>/dev/null | grep -v "$SCRIPT_PATH" | crontab -
        (crontab -l 2>/dev/null; echo "$cron_line") | crontab -
        echo "โ Cron ะพะฑะฝะพะฒะปะตะฝ!"
    else
        echo "โน๏ธ  Cron ะฝะต ะธะทะผะตะฝะตะฝ"
    fi
else
    # ะะพะฑะฐะฒะปัะตะผ ะฝะพะฒัั ัััะพะบั
    (crontab -l 2>/dev/null; echo "$cron_line") | crontab -
    echo "โ Cron ะฝะฐัััะพะตะฝ!"
fi

echo ""
echo "๐ ะะฐัััะพะนะบะฐ ะทะฐะฒะตััะตะฝะฐ!"
echo ""
echo "๐ ะัะพะฒะตัะธัั ัะฐะฑะพัั:"
echo "  tail -f watcher.log"
echo ""
echo "๐ ะััะฐะฝะพะฒะธัั:"
echo "  crontab -e  # ะธ ัะดะฐะปะธัั ัััะพะบั"
echo ""
echo "๐ ะกัะฐัะธััะธะบะฐ:"
echo "  ls downloads/ | wc -l  # ะบะพะปะธัะตััะฒะพ ัะฐะนะปะพะฒ"
