# CloudPBX RT Calls Downloader

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Python 3.12](https://img.shields.io/badge/python-3.12-blue.svg)](https://www.python.org/downloads/)
[![Platform: Linux](https://img.shields.io/badge/platform-Linux%20%7C%20macOS-lightgrey.svg)](https://github.com/FUYOH666/voip-calls-downloader)

**Автоматический загрузчик записей звонков из CloudPBX Ростелеком. Система автоматически загружает записи входящих звонков длительностью более 3 минут и сохраняет их в указанную папку.**

---

## Краткое описание

CloudPBX RT Calls Downloader — это инструмент для автоматической загрузки записей телефонных звонков из CloudPBX Ростелеком. Проект помогает избавиться от ручной рутины, экономя время и энергию.

---

## Проблемы, которые решает

- **Ручная загрузка записей** — больше не нужно вручную заходить в личный кабинет CloudPBX и скачивать файлы
- **Множественные аккаунты** — поддержка работы с до 16 аккаунтами одновременно
- **Отслеживание новых звонков** — автоматический мониторинг и загрузка новых записей
- **Дублирование файлов** — автоматическое отслеживание уже загруженных записей
- **Фильтрация** — настройка фильтров по длительности и направлению звонков

---

## Возможности

- ✅ Автоматическая загрузка записей входящих звонков
- ✅ Поддержка до 16 аккаунтов одновременно (параллельная обработка)
- ✅ Фильтрация по длительности звонков (настраиваемый минимум)
- ✅ Автоматический мониторинг новых записей
- ✅ Защита от дублирования загрузок (база данных SQLite)
- ✅ Настраиваемые интервалы проверки
- ✅ Подробное логирование всех операций
- ✅ Автозапуск через systemd (опционально)

---

## Требования

- **Python 3.12** (должен быть установлен в системе)
- **Linux** или **macOS** (Windows не поддерживается)
- Учетные данные для доступа к CloudPBX Ростелеком (логин, пароль, домен)

---

## Установка

### Шаг 1: Подготовка проекта

```bash
cd rostelcom
```

### Шаг 2: Создание виртуального окружения

```bash
python3.12 -m venv venv
source venv/bin/activate  # или: . venv/bin/activate
```

### Шаг 3: Установка зависимостей

```bash
pip install --upgrade pip
pip install -r requirements.txt
```

---

## Конфигурация

### Шаг 1: Создание файла конфигурации

Скопируйте пример конфигурации:

```bash
cp env_example.txt .env
```

### Шаг 2: Редактирование .env файла

Откройте файл `.env` в любом текстовом редакторе и заполните ваши данные.

#### Для одного аккаунта (простой режим):

```bash
CITY_1_NAME=Название_вашего_аккаунта
CITY_1_LOGIN=ваш_логин
CITY_1_PASSWORD=ваш_пароль
CITY_1_DOMAIN=ваш_домен.rt.ru
```

#### Для нескольких аккаунтов:

Заполните данные для каждого аккаунта (от CITY_1 до CITY_16):

```bash
CITY_1_NAME=Название_аккаунта_1
CITY_1_LOGIN=логин1
CITY_1_PASSWORD=пароль1
CITY_1_DOMAIN=XXXXXX.XX.rt.ru

CITY_2_NAME=Название_аккаунта_2
CITY_2_LOGIN=логин2
CITY_2_PASSWORD=пароль2
CITY_2_DOMAIN=XXXXXX.XX.rt.ru

# ... и так далее для всех нужных аккаунтов
```

### Шаг 3: Настройка папки для загрузок

В файле `.env` найдите строку:

```bash
DOWNLOAD_DIR=./downloads
```

Вы можете изменить путь на свой (абсолютный или относительный).

---

## Использование

### Режим одного аккаунта

**Однократный запуск (тест):**
```bash
./venv/bin/python call_records_watcher.py --city-id 1 --once
```

**Непрерывный режим (проверка каждые 5 минут):**
```bash
./venv/bin/python call_records_watcher.py --city-id 1
```

Для остановки нажмите `Ctrl+C`.

### Режим нескольких аккаунтов (рекомендуется)

**Однократный запуск (тест):**
```bash
./run_multi_watcher.sh --once
```

**Непрерывный режим:**
```bash
./run_multi_watcher.sh
```

Скрипт автоматически:
- Проверит наличие виртуального окружения
- Проверит наличие .env файла
- Запустит загрузку для всех заполненных аккаунтов параллельно

Для остановки нажмите `Ctrl+C`.

---

## Проверка работы

### Проверка скачанных файлов

Файлы сохраняются в папку, указанную в `DOWNLOAD_DIR` (по умолчанию `./downloads`):

```bash
ls -lh downloads/
```

Вы должны увидеть MP3 файлы с именами вида:
```
2025-01-15_14-30-45_79991234567_180sec.mp3
```

### Проверка логов

Логи сохраняются в файлы:
- `watcher.log` - общий лог (для одного аккаунта)
- `multi_account_orchestrator.log` - лог оркестратора (для нескольких аккаунтов)
- `watcher_city_N.log` - лог для каждого аккаунта

Просмотр логов:
```bash
tail -f watcher.log
```

Или для нескольких аккаунтов:
```bash
tail -f watcher_city_*.log
```

### Проверка базы данных

Система использует базу данных SQLite для отслеживания уже загруженных файлов. База создается автоматически при первом запуске.

Посмотреть статистику:
```bash
sqlite3 cloudpbx_calls.db "SELECT COUNT(*) as total_files FROM downloaded_records;"
```

---

## Дополнительные настройки

Все настройки находятся в файле `.env`. Основные параметры:

| Параметр | Значение по умолчанию | Описание |
|----------|----------------------|----------|
| `DOWNLOAD_DIR` | `./downloads` | Папка для сохранения MP3 файлов |
| `MIN_DURATION_SECONDS` | `180` | Минимальная длительность звонка (3 минуты) |
| `ONLY_INCOMING` | `true` | Только входящие звонки |
| `CHECK_INTERVAL` | `300` | Интервал проверки новых звонков (5 минут) |
| `LOOKBACK_HOURS` | `24` | За какой период искать звонки (24 часа) |
| `LOG_LEVEL` | `INFO` | Уровень логирования (DEBUG, INFO, WARNING, ERROR) |

---

## Автозапуск (опционально)

Если вы хотите, чтобы система запускалась автоматически при загрузке компьютера, можно настроить автозапуск через systemd.

### Создание службы systemd

Создайте файл `/etc/systemd/system/cloudpbx-downloader.service`:

```bash
sudo nano /etc/systemd/system/cloudpbx-downloader.service
```

Вставьте следующее содержимое (замените `your_username` на ваше имя пользователя и `/path/to/project` на реальный путь к проекту):

```ini
[Unit]
Description=CloudPBX RT Calls Downloader
After=network.target

[Service]
Type=simple
User=your_username
WorkingDirectory=/path/to/project
ExecStart=/path/to/project/venv/bin/python multi_account_downloader.py
Restart=always
RestartSec=60

[Install]
WantedBy=multi-user.target
```

### Активация службы

```bash
sudo systemctl daemon-reload
sudo systemctl enable cloudpbx-downloader
sudo systemctl start cloudpbx-downloader
```

### Проверка статуса

```bash
sudo systemctl status cloudpbx-downloader
```

### Просмотр логов

```bash
journalctl -u cloudpbx-downloader -f
```

---

## Структура проекта

```
rostelcom/
├── cloudpbx_auth.py              # Модуль аутентификации
├── call_records_watcher.py        # Загрузчик для одного аккаунта
├── multi_account_downloader.py    # Оркестратор для нескольких аккаунтов
├── run_multi_watcher.sh          # Скрипт запуска (несколько аккаунтов)
├── run_watcher.sh                 # Скрипт запуска (один аккаунт)
├── config.yaml                    # Конфигурация (справочная)
├── env_example.txt                # Пример конфигурации
├── requirements.txt               # Зависимости Python
├── tests/                         # Тесты
└── README.md                      # Эта инструкция
```

---

## Частые проблемы

### Ошибка: "файл .env не найден"

**Решение:** Убедитесь, что вы скопировали `env_example.txt` в `.env`:
```bash
cp env_example.txt .env
```

### Ошибка: "Не установлены обязательные переменные"

**Решение:** Проверьте, что в `.env` файле заполнены все необходимые поля:
- `CITY_N_NAME`
- `CITY_N_LOGIN`
- `CITY_N_PASSWORD`
- `CITY_N_DOMAIN`

Замените `N` на номер аккаунта (1, 2, 3 и т.д.).

### Ошибка: "Ошибка аутентификации"

**Решение:** Проверьте:
1. Правильность логина и пароля
2. Правильность домена (формат: `XXXXXX.XX.rt.ru`)
3. Наличие интернет-соединения

### Файлы не скачиваются

**Возможные причины:**
1. Нет звонков длительностью более 3 минут за последние 24 часа
2. Нет входящих звонков (если включен фильтр `ONLY_INCOMING=true`)
3. Звонки уже были загружены ранее (проверяется по базе данных)

**Решение:** Проверьте настройки в `.env`:
- `MIN_DURATION_SECONDS` - минимальная длительность (по умолчанию 180 секунд = 3 минуты)
- `ONLY_INCOMING` - только входящие звонки (по умолчанию `true`)
- `LOOKBACK_HOURS` - за какой период искать звонки (по умолчанию 24 часа)

### Скрипт не запускается (permission denied)

**Решение:** Сделайте скрипт исполняемым:
```bash
chmod +x run_multi_watcher.sh
chmod +x run_watcher.sh
```

---

## Поддержка

При возникновении проблем проверьте:
1. Правильность заполнения `.env` файла
2. Логи (файлы `*.log`)
3. Наличие интернет-соединения
4. Версию Python (должна быть 3.12)

---

## Contributing

Мы рады любому вкладу! Пожалуйста, прочитайте [CONTRIBUTING.md](../CONTRIBUTING.md) в корне репозитория.

---

## Лицензия

Этот проект распространяется под лицензией MIT. См. [LICENSE](../LICENSE) для получения подробной информации.

---

**Готово к использованию!** Система автоматически загружает записи звонков и отслеживает уже загруженные файлы, чтобы не скачивать их повторно.
